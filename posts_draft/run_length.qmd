---
title: "Counting consecutive sequences: run length encoding and warm spell durations example"
date: "2023-11-02"
categories: [rle]
---

Some days ago I was trying to count how many times consecutive sequences with values higher than a reference appears in a data frame.

For example:

$x = {2,2,3,4,4,5,6,7,3,7,7,1,6,7,8}$

On $x$, how many times values higher than four appears in consecutive sequences with three or more elements?

Two times: the sequences $5,6,7$ and $6,7,8$.

But how to figure this out with R?

## Run length encodig

Base R has an interesting function called Run Length Encoding: `rle(x)`. Let's see how this works with our example.

```{r}
x <- c(2,2,3,4,4,5,6,7,3,7,7,1,6,7,8)

rle(x)
```

The `rle` function returns a list with lengths and values. The "lengths" says how many times the "values" appears.

## Count consecutive sequences

To actually count consecutive sequences of a certain size (`l`) of values higher than a reference (`v`), I created a little function:

```{r}
trle <- function(x, l, v){
  x_logical <- x >= v #<1>
  
  rle_list <- rle(x_logical) #<2>

  rle_df <- data.frame(        #<3>
    length = rle_list$lengths, #<3>
    value = rle_list$values    #<3>
  )

  res_df <- subset(rle_df, value == TRUE & length >= l) #<4>
  
  res <- nrow(res_df) #<5>

  return(res)
}
```

1.  Check if each element of `x` is higher or equal to `v`. This will return a vector of true and false values.
2.  Run the `rle` function over the sequence of true/false values.
3.  Convert the list in a data frame object.
4.  Filter the row where values equal to `TRUE` that have lenghts higher than `l`.
5.  Count the rows. That's the result!

Let's test it with our example.

```{r}
trle(x, l = 3, v = 4)
```

## Warm spell example

In climatology there is an indicator called Warm Spell Duration Index (WSDI). A warm spell consist of at least six consecutive days with maximum temperatures higher than the climatological normal maximum temperature.

I will get some temperature values with the `brclimr` package for Rio de Janeiro, Brazil.

```{r}
rio <- brclimr::fetch_data(
  code_muni = 3304557,
  product = "brdwgd", 
  indicator = "tmax", 
  statistics = "mean", 
  date_start = as.Date("2020-01-01"),
  date_end = as.Date("2020-12-31")
)

head(rio, 10)
```

Let's assume the reference value as 30. How many sequences of six days or more had temperatures higher than 30 degrees C?

```{r}
trle(x = rio$value, l = 6, v = 30)
```

This happened three times on 2020.
