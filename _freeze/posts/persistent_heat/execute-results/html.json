{
  "hash": "ff7ac2f89a1ff1a8bd3ac3be597b7182",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Persistent heat in Brazil: 1993 and 2023\"\ndate: \"2024-04-22\"\ncategories: [climate]\n---\n\n\n\nPersistent heat, or heat waves, are defined as sequences of days with temperatures above a reference value. These sequences of days of extreme heat are direct consequences of the global warming and impact the health of the inhabitants, specially those with less access to basic resources.\n\nLet's take a look at the occurrence of persistent heat in Brazilian municipalities in two years: 2023 and 1993 (thirty years ago).\n\nFor this, I will use the datasets of Zonal Statistics of Climate Indicators created with ERA5-Land data. More details about this dataset is available here.\n\n## Packages\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) #<1>\nlibrary(arrow) #<2>\nlibrary(zendown) #<3>\nlibrary(nseq) #<4>\n```\n:::\n\n\n\n1.  Functions for data manipulation.\n2.  Functions to work with parquet files.\n3.  Download and cache data from Zenodo. More details about this package [here](https://rfsaldanha.github.io/zendown/).\n4.  Compute sequences of events. More details about this package [here](https://rfsaldanha.github.io/nseq/).\n\n## Data download\n\nWe will use data about the daily average maximum temperature on Brazilian municipalities.\n\n### 2023 data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp_max_2023 <- zen_file(10947952, \"2m_temperature_max.parquet\") |> #<1>\n  open_dataset() |> #<2>\n  filter(name == \"2m_temperature_max_mean\") |> #<3>\n  select(-name) |> #<3>\n  mutate(value = value - 272.15) |> #<4>\n  arrange(code_muni, date) |> #<5>\n  collect() #<6>\n```\n:::\n\n\n\n1.  Download and cache parquet file from Zenodo.\n2.  Creates a connection to the file, but do not load it to the memory. This file is pretty big.\n3.  Keep only the average maximum temperature indicator.\n4.  Convert from Kelvin to Celsius.\n5.  Arrange rows by municipality code and date.\n6.  Collect the filtered data to memory.\n\n### 1993 data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp_max_1993 <- zen_file(10036212, \"2m_temperature_max.parquet\") |>\n  open_dataset() |>\n  filter(name == \"2m_temperature_max_mean\") |>\n  select(-name) |> \n  filter(year(date) == 1993) |>\n  mutate(value = value - 272.15) |>\n  arrange(code_muni, date) |>\n  collect()\n```\n:::\n\n\n\nThe steps are basically the same, but we filter the 1993 data.\n\n## Persistent heat sequences\n\nLet's compute some persistent heat sequences for all municipalities using the `dplyr::summary` and the `nseq::trle_cond` functions.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_2023 <- temp_max_2023 |>\n  summarise(\n    temp_3_35 = trle_cond(value, a_op = \"gte\", a = 3, b_op = \"gte\", b = 35), #<1>\n    temp_5_35 = trle_cond(value, a_op = \"gte\", a = 5, b_op = \"gte\", b = 35), #<2>\n    temp_3_40 = trle_cond(value, a_op = \"gte\", a = 3, b_op = \"gte\", b = 40), #<3>\n    temp_5_40 = trle_cond(value, a_op = \"gte\", a = 5, b_op = \"gte\", b = 40), #<4>\n    .by = code_muni\n  )\n```\n:::\n\n\n\nFor the year of 2023, on each municipality, we are answering these questions:\n\n1.  How many times we got sequences of 3 days or more with temperatures of 35 Celsius or more?\n2.  How many times we got sequences of 5 days or more with temperatures of 35 Celsius or more?\n3.  How many times we got sequences of 3 days or more with temperatures of 40 Celsius or more?\n4.  How many times we got sequences of 5 days or more with temperatures of 40 Celsius or more?\n\nLet's do the same with the 1993 data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_1993 <- temp_max_1993 |>\n  summarise(\n    temp_3_35 = trle_cond(value, a_op = \"gte\", a = 3, b_op = \"gte\", b = 35), #<1>\n    temp_5_35 = trle_cond(value, a_op = \"gte\", a = 5, b_op = \"gte\", b = 35), #<2>\n    temp_3_40 = trle_cond(value, a_op = \"gte\", a = 3, b_op = \"gte\", b = 40), #<3>\n    temp_5_40 = trle_cond(value, a_op = \"gte\", a = 5, b_op = \"gte\", b = 40), #<4>\n    .by = code_muni\n  )\n```\n:::\n\n\n\nLet's take a look first at the more extreme result: five days or more with temperatures above 40 Celsius degrees.\n\nOn 2023, 14 municipalities presented those conditions. This conditions of extreme heat occurred 4 times at the municipality of Barão de Melgaço, MT. On 1993, these conditions did not occur on any municipality.\n\n## Maps\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(geobr)\nlibrary(sf)\nlibrary(viridisLite)\n\nuf <- read_state(showProgress = FALSE)\ncoords <- read_municipality(showProgress = FALSE) %>%\n  st_make_valid() %>%\n  st_centroid()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nres_2023_map <- left_join(coords, res_2023, by = \"code_muni\") |>\n  drop_na()\n\nres_1993_map <- left_join(coords, res_1993, by = \"code_muni\") |>\n  drop_na()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_2023_map, temp_3_35 > 0), aes(color = temp_3_35), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 3 dias ou mais \", subtitle = \"com temperatura acima de 35 graus Celsius em 2023\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_1993_map, temp_3_35 > 0), aes(color = temp_3_35), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 3 dias ou mais \", subtitle = \"com temperatura acima de 35 graus Celsius em 1993\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_2023_map, temp_5_35 > 0), aes(color = temp_5_35), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 5 dias ou mais\", subtitle = \"com temperatura acima de 35 graus Celsius em 2023\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_1993_map, temp_5_35 > 0), aes(color = temp_5_35), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 5 dias ou mais\", subtitle = \"com temperatura acima de 35 graus Celsius em 1993\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_2023_map, temp_3_40 > 0), aes(color = temp_3_40), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 3 dias ou mais\", subtitle = \"com temperatura acima de 40 graus Celsius em 2023\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_1993_map, temp_3_40 > 0), aes(color = temp_3_40), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 3 dias ou mais\", subtitle = \"com temperatura acima de 40 graus Celsius em 1993\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_2023_map, temp_5_40 > 0), aes(color = temp_5_40), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 5 dias ou mais\", subtitle = \"com temperatura acima de 40 graus Celsius em 2023\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf, fill = \"grey30\", color = \"grey50\", size=.15, show.legend = FALSE) +\n  geom_sf(data = subset(res_1993_map, temp_5_40 > 0), aes(color = temp_5_40), size = 1, alpha = 0.5) +\n  scale_colour_viridis_c(option = \"turbo\") +\n  theme_minimal() +\n  labs(title = \"Número de ocorrências de 5 dias ou mais\", subtitle = \"com temperatura acima de 40 graus Celsius em 1993\", color = NULL)\n```\n\n::: {.cell-output-display}\n![](persistent_heat_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n## Session info\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessioninfo::session_info()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n─ Session info ───────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.3.3 (2024-02-29)\n os       Ubuntu 22.04.4 LTS\n system   x86_64, linux-gnu\n ui       X11\n language en_US:en\n collate  en_US.UTF-8\n ctype    en_US.UTF-8\n tz       Europe/Paris\n date     2024-04-22\n pandoc   3.1.1 @ /usr/lib/rstudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────\n package     * version date (UTC) lib source\n arrow       * 15.0.1  2024-03-12 [1] CRAN (R 4.3.3)\n assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.3.1)\n backports     1.4.1   2021-12-13 [1] CRAN (R 4.3.1)\n bit           4.0.5   2022-11-15 [1] CRAN (R 4.3.1)\n bit64         4.0.5   2020-08-30 [1] CRAN (R 4.3.1)\n checkmate     2.3.1   2023-12-04 [1] CRAN (R 4.3.2)\n class         7.3-22  2023-05-03 [4] CRAN (R 4.3.1)\n classInt      0.4-10  2023-09-05 [1] CRAN (R 4.3.1)\n cli           3.6.2   2023-12-11 [1] CRAN (R 4.3.2)\n colorspace    2.1-0   2023-01-23 [1] CRAN (R 4.3.1)\n curl          5.2.1   2024-03-01 [1] CRAN (R 4.3.3)\n data.table    1.15.4  2024-03-30 [1] CRAN (R 4.3.3)\n DBI           1.2.2   2024-02-16 [1] CRAN (R 4.3.2)\n digest        0.6.35  2024-03-11 [1] CRAN (R 4.3.3)\n dplyr       * 1.1.4   2023-11-17 [1] CRAN (R 4.3.2)\n e1071         1.7-14  2023-12-06 [1] CRAN (R 4.3.2)\n evaluate      0.23    2023-11-01 [1] CRAN (R 4.3.1)\n fansi         1.0.6   2023-12-08 [1] CRAN (R 4.3.2)\n farver        2.1.1   2022-07-06 [1] CRAN (R 4.3.1)\n fastmap       1.1.1   2023-02-24 [1] CRAN (R 4.3.1)\n forcats     * 1.0.0   2023-01-29 [1] CRAN (R 4.3.1)\n fs            1.6.3   2023-07-20 [1] CRAN (R 4.3.1)\n generics      0.1.3   2022-07-05 [1] CRAN (R 4.3.1)\n geobr       * 1.9.0   2024-04-18 [1] CRAN (R 4.3.3)\n ggplot2     * 3.5.0   2024-02-23 [1] CRAN (R 4.3.2)\n glue          1.7.0   2024-01-09 [1] CRAN (R 4.3.2)\n gtable        0.3.4   2023-08-21 [1] CRAN (R 4.3.1)\n hms           1.1.3   2023-03-21 [1] CRAN (R 4.3.1)\n htmltools     0.5.8.1 2024-04-04 [1] CRAN (R 4.3.3)\n htmlwidgets   1.6.4   2023-12-06 [1] CRAN (R 4.3.2)\n httr          1.4.7   2023-08-15 [1] CRAN (R 4.3.1)\n jsonlite      1.8.8   2023-12-04 [1] CRAN (R 4.3.2)\n KernSmooth    2.23-22 2023-07-10 [4] CRAN (R 4.3.1)\n knitr         1.46    2024-04-06 [1] CRAN (R 4.3.3)\n labeling      0.4.3   2023-08-29 [1] CRAN (R 4.3.1)\n lifecycle     1.0.4   2023-11-07 [1] CRAN (R 4.3.2)\n lubridate   * 1.9.3   2023-09-27 [1] CRAN (R 4.3.1)\n magrittr      2.0.3   2022-03-30 [1] CRAN (R 4.3.1)\n munsell       0.5.1   2024-04-01 [1] CRAN (R 4.3.3)\n nseq        * 0.0.1   2024-04-22 [1] local\n pillar        1.9.0   2023-03-22 [1] CRAN (R 4.3.1)\n pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.3.1)\n proxy         0.4-27  2022-06-09 [1] CRAN (R 4.3.1)\n purrr       * 1.0.2   2023-08-10 [1] CRAN (R 4.3.1)\n R6            2.5.1   2021-08-19 [1] CRAN (R 4.3.1)\n Rcpp          1.0.12  2024-01-09 [1] CRAN (R 4.3.2)\n readr       * 2.1.5   2024-01-10 [1] CRAN (R 4.3.2)\n rlang         1.1.3   2024-01-10 [1] CRAN (R 4.3.2)\n rmarkdown     2.26    2024-03-05 [1] CRAN (R 4.3.3)\n rstudioapi    0.16.0  2024-03-24 [1] CRAN (R 4.3.3)\n s2            1.1.6   2023-12-19 [1] CRAN (R 4.3.2)\n scales        1.3.0   2023-11-28 [1] CRAN (R 4.3.2)\n sessioninfo   1.2.2   2021-12-06 [1] CRAN (R 4.3.1)\n sf          * 1.0-16  2024-03-24 [1] CRAN (R 4.3.3)\n stringi       1.8.3   2023-12-11 [1] CRAN (R 4.3.2)\n stringr     * 1.5.1   2023-11-14 [1] CRAN (R 4.3.2)\n tibble      * 3.2.1   2023-03-20 [1] CRAN (R 4.3.1)\n tidyr       * 1.3.1   2024-01-24 [1] CRAN (R 4.3.2)\n tidyselect    1.2.1   2024-03-11 [1] CRAN (R 4.3.3)\n tidyverse   * 2.0.0   2023-02-22 [1] CRAN (R 4.3.1)\n timechange    0.3.0   2024-01-18 [1] CRAN (R 4.3.2)\n tzdb          0.4.0   2023-05-12 [1] CRAN (R 4.3.1)\n units         0.8-5   2023-11-28 [1] CRAN (R 4.3.2)\n utf8          1.2.4   2023-10-22 [1] CRAN (R 4.3.1)\n vctrs         0.6.5   2023-12-01 [1] CRAN (R 4.3.2)\n viridisLite * 0.4.2   2023-05-02 [1] CRAN (R 4.3.1)\n withr         3.0.0   2024-01-16 [1] CRAN (R 4.3.2)\n wk            0.9.1   2023-11-29 [1] CRAN (R 4.3.2)\n xfun          0.43    2024-03-25 [1] CRAN (R 4.3.3)\n yaml          2.3.8   2023-12-11 [1] CRAN (R 4.3.2)\n zendown     * 0.1.0   2024-04-15 [1] local\n\n [1] /home/raphael/R/x86_64-pc-linux-gnu-library/4.3\n [2] /usr/local/lib/R/site-library\n [3] /usr/lib/R/site-library\n [4] /usr/lib/R/library\n\n──────────────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n:::\n",
    "supporting": [
      "persistent_heat_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}